<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Workflow | ReplyHQ</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #DC2626;
            --primary-glow: rgba(220, 38, 38, 0.4);
            --bg: #09090b;
            --surface: #18181b;
            --surface-highlight: #27272a;
            --border: rgba(255, 255, 255, 0.1);
            --text: #F4F4F5;
            --text-dim: #A1A1AA;
            --success: #22c55e;
            --warning: #eab308;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            /* Prevent text selection while dragging */
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #111;
            color: var(--text);
            line-height: 1.6;
            overflow: hidden;
            height: 100vh;
        }

        /* Top Bar */
        .editor-header {
            height: 60px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            z-index: 100;
            position: relative;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .flow-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text);
            background: transparent;
            border: none;
            outline: none;
            width: 200px;
        }

        /* Main Layout */
        .editor-body {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Sidebar Palette */
        .palette {
            width: 260px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
            z-index: 100;
        }

        .palette-section {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .palette-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-dim);
            font-weight: 700;
            margin-bottom: 1rem;
            letter-spacing: 0.5px;
        }

        .node-tile {
            background: var(--surface-highlight);
            border: 1px solid var(--border);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: grab;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .node-tile:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .node-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        /* Canvas */
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #0b0b0d;
        }

        /* SVG Connections Layer */
        .connections-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .connection-path {
            stroke: #555;
            stroke-width: 2px;
            fill: none;
            transition: stroke 0.2s;
        }

        .connection-path:hover,
        .connection-path.selected {
            stroke: var(--primary);
            stroke-width: 3px;
            cursor: pointer;
            pointer-events: all;
        }

        /* Nodes on Canvas */
        .flow-node {
            position: absolute;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 260px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 10;
            cursor: pointer;
        }

        .flow-node:hover {
            border-color: #555;
        }

        .flow-node.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.4);
        }

        .flow-node.trigger {
            border-top: 4px solid var(--success);
        }

        .flow-node.action {
            border-top: 4px solid var(--primary);
        }

        .flow-node.condition {
            border-top: 4px solid var(--warning);
        }

        .node-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 0.9rem;
            pointer-events: none;
            /* Let clicks pass to node */
        }

        .node-body {
            padding: 1rem;
            font-size: 0.85rem;
            color: var(--text-dim);
            pointer-events: none;
        }

        /* Connection Handles */
        .handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--text-dim);
            border: 2px solid var(--surface);
            border-radius: 50%;
            cursor: crosshair;
            transition: all 0.2s;
            z-index: 20;
        }

        .handle:hover {
            background: var(--primary);
            transform: scale(1.2);
        }

        .handle.top {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .handle.bottom {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Branch handles for condition nodes */
        .handle.bottom-left {
            bottom: -6px;
            left: 25%;
            transform: translateX(-50%);
            background: var(--success);
        }

        .handle.bottom-right {
            bottom: -6px;
            left: 75%;
            transform: translateX(-50%);
            background: var(--primary);
        }

        .btn {
            background: var(--text);
            color: var(--bg);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        /* Drag Ghost */
        .dragging-ghost {
            opacity: 0.5;
            position: fixed;
            pointer-events: none;
            z-index: 1000;
        }
    </style>
</head>

<body>

    <div class="editor-header">
        <div class="header-left">
            <a href="workflows.html" style="color: var(--text-dim); text-decoration: none;">&larr;</a>
            <input type="text" class="flow-name" value="Onboarding + Upsell">
            <span
                style="font-size: 0.8rem; color: var(--success); background: rgba(34, 197, 94, 0.1); padding: 2px 6px; border-radius: 4px;">Active</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" style="margin-right: 0.5rem;" onclick="showJSON()">Show JSON</button>
            <button class="btn btn-primary" onclick="alert('Workflow Saved!')">Save Changes</button>
        </div>
    </div>

    <!-- JSON Modal -->
    <div id="json-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div
            style="background: var(--surface); width: 80%; max-width: 800px; height: 80%; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column;">
            <div
                style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1.1rem;">Workflow Data</h3>
                <button onclick="closeModal()"
                    style="background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div style="flex: 1; padding: 1rem; overflow: hidden;">
                <textarea id="json-output"
                    style="width: 100%; height: 100%; background: #000; color: #0f0; font-family: monospace; border: none; outline: none; resize: none; padding: 1rem; border-radius: 8px;"
                    readonly></textarea>
            </div>
            <div style="padding: 1rem; text-align: right; border-top: 1px solid var(--border);">
                <button class="btn btn-primary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="editor-body">
        <!-- Sidebar -->
        <div class="palette">
            <div class="palette-section">
                <div class="palette-title">Triggers</div>
                <div class="node-tile" draggable="true" ondragstart="dragStart(event)" data-type="trigger"
                    data-label="User Signup" data-icon="‚ö°Ô∏è">
                    <div class="node-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--success);">‚ö°Ô∏è</div>
                    User Signup
                </div>
                <div class="node-tile" draggable="true" ondragstart="dragStart(event)" data-type="trigger"
                    data-label="App Opened" data-icon="‚ö°Ô∏è">
                    <div class="node-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--success);">‚ö°Ô∏è</div>
                    App Opened
                </div>
                <!-- More triggers... -->
            </div>

            <div class="palette-section">
                <div class="palette-title">Logic</div>
                <div class="node-tile" draggable="true" ondragstart="dragStart(event)" data-type="condition"
                    data-label="Condition" data-icon="?">
                    <div class="node-icon" style="background: rgba(234, 179, 8, 0.1); color: var(--warning);">?</div>
                    Condition
                </div>
                <div class="node-tile" draggable="true" ondragstart="dragStart(event)" data-type="logic"
                    data-label="Wait Delay" data-icon="‚è≥">
                    <div class="node-icon" style="background: rgba(234, 179, 8, 0.1); color: var(--warning);">‚è≥</div>
                    Wait Delay
                </div>
            </div>

            <div class="palette-section">
                <div class="palette-title">Actions</div>
                <div class="node-tile" draggable="true" ondragstart="dragStart(event)" data-type="action"
                    data-label="Send Email" data-icon="‚úâÔ∏è">
                    <div class="node-icon" style="background: rgba(220, 38, 38, 0.1); color: var(--primary);">‚úâÔ∏è</div>
                    Send Email
                </div>
                <div class="node-tile" draggable="true" ondragstart="dragStart(event)" data-type="action"
                    data-label="Show Banner" data-icon="üì≤">
                    <div class="node-icon" style="background: rgba(220, 38, 38, 0.1); color: var(--primary);">üì≤</div>
                    Show Banner
                </div>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-container" id="canvas" ondrop="drop(event)" ondragover="allowDrop(event)">
            <svg class="connections-layer" id="svg-layer">
                <!-- Edges will be drawn here -->
            </svg>
            <!-- Nodes will be appended here -->
        </div>
    </div>

    <script>
        // --- 1. Data Model ---
        const state = {
            nodes: [
                { id: '1', type: 'trigger', label: 'User Signup', icon: '‚ö°Ô∏è', x: 400, y: 50, data: { desc: "Trigger on new account" } },
                { id: '2', type: 'logic', label: 'Wait 2 Days', icon: '‚è≥', x: 400, y: 200, data: { desc: "Delay execution" } },
                { id: '3', type: 'condition', label: 'Is Pro User?', icon: '?', x: 400, y: 350, data: { desc: "Check user.plan" } },
                { id: '4', type: 'action', label: 'Send Upsell', icon: '‚úâÔ∏è', x: 250, y: 500, data: { desc: "Get 50% Off" } },
                { id: '5', type: 'action', label: 'Send Welcome', icon: '‚úâÔ∏è', x: 550, y: 500, data: { desc: "Thanks for subscribing" } }
            ],
            edges: [
                { id: 'e1', source: '1', target: '2', sourceHandle: 'bottom', targetHandle: 'top' },
                { id: 'e2', source: '2', target: '3', sourceHandle: 'bottom', targetHandle: 'top' },
                { id: 'e3', source: '3', target: '4', sourceHandle: 'bottom-left', targetHandle: 'top' }, // No branch
                { id: 'e4', source: '3', target: '5', sourceHandle: 'bottom-right', targetHandle: 'top' }  // Yes branch
            ],
            selectedNodeId: null,
            draggedNodeId: null,
            dragOffset: { x: 0, y: 0 },
            isConnecting: false,
            connectingSourceId: null,
            connectingSourceHandle: null,
            tempConnectionPos: { x: 0, y: 0 }
        };

        const canvas = document.getElementById('canvas');
        const svgLayer = document.getElementById('svg-layer');

        // --- 2. RENDER LOOP ---
        function render() {
            // Clear current nodes (inefficient but simple for prototype)
            // Ideally we diff, but for < 100 nodes this is fine
            document.querySelectorAll('.flow-node').forEach(el => el.remove());

            // Render Nodes
            state.nodes.forEach(node => {
                const nodeEl = document.createElement('div');
                nodeEl.className = `flow-node ${node.type} ${state.selectedNodeId === node.id ? 'selected' : ''}`;
                nodeEl.id = `node-${node.id}`; // Add ID for easier hit testing
                nodeEl.style.left = node.x + 'px';
                nodeEl.style.top = node.y + 'px';
                nodeEl.dataset.id = node.id;

                // HTML Content
                nodeEl.innerHTML = `
                    <div class="node-header">
                        <span>${node.icon} ${node.label}</span>
                        <span style="opacity:0.5; cursor:pointer;" onclick="deleteNode('${node.id}', event)">√ó</span>
                    </div>
                    <div class="node-body">${node.data.desc || ''}</div>
                `;

                // Add Handles
                if (node.type !== 'trigger') {
                    addHandle(nodeEl, 'top', node.id);
                }

                if (node.type === 'condition') {
                    addHandle(nodeEl, 'bottom-left', node.id); // No
                    addHandle(nodeEl, 'bottom-right', node.id); // Yes
                } else if (node.type !== 'end') {
                    addHandle(nodeEl, 'bottom', node.id);
                }

                // Event Listeners for dragging node
                nodeEl.addEventListener('mousedown', (e) => startNodeDrag(e, node.id));

                // Allow dropping connections ON the node body
                nodeEl.addEventListener('mouseup', (e) => {
                    // Check if we are connecting
                    if (state.isConnecting) {
                        e.stopPropagation(); // Prevent canvas drop logic if any
                        endConnection(e, node.id, 'top'); // Default to 'top' when dropping on body
                    }
                });

                canvas.appendChild(nodeEl);
            });

            // Render Edges
            // Clear SVG
            while (svgLayer.firstChild) {
                svgLayer.removeChild(svgLayer.firstChild);
            }

            // Draw existing edges
            state.edges.forEach(edge => {
                const sourceNode = state.nodes.find(n => n.id === edge.source);
                const targetNode = state.nodes.find(n => n.id === edge.target);
                if (sourceNode && targetNode) {
                    const path = createPath(sourceNode, targetNode, edge.sourceHandle, edge.targetHandle);
                    const pathEl = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    pathEl.setAttribute("d", path);
                    pathEl.setAttribute("class", "connection-path");
                    // Add click to delete edge
                    pathEl.onclick = (e) => {
                        if (confirm('Delete connection?')) {
                            state.edges = state.edges.filter(e => e.id !== edge.id);
                            render();
                        }
                    };
                    svgLayer.appendChild(pathEl);
                }
            });

            // Draw creating connection line
            if (state.isConnecting && state.connectingSourceId) {
                const sourceNode = state.nodes.find(n => n.id === state.connectingSourceId);
                if (sourceNode) {
                    // We need explicit Coords for handles
                    const p1 = getHandleCoords(sourceNode, state.connectingSourceHandle);
                    const p2 = { x: state.tempConnectionPos.x, y: state.tempConnectionPos.y };

                    const d = `M ${p1.x} ${p1.y} C ${p1.x} ${p1.y + 50}, ${p2.x} ${p2.y - 50}, ${p2.x} ${p2.y}`;

                    const pathEl = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    pathEl.setAttribute("d", d);
                    pathEl.setAttribute("stroke", "#DC2626");
                    pathEl.setAttribute("stroke-width", "2");
                    pathEl.setAttribute("fill", "none");
                    pathEl.setAttribute("stroke-dasharray", "5,5");
                    // Ignore pointer events so we can drop on elements below it
                    pathEl.style.pointerEvents = "none";
                    svgLayer.appendChild(pathEl);
                }
            }
        }

        // --- Helper: Add Handle ---
        function addHandle(parent, position, nodeId) {
            const handle = document.createElement('div');
            handle.className = `handle ${position}`;
            handle.dataset.id = nodeId;
            handle.dataset.position = position;

            // Stop propagation to prevent node dragging when clicking handle
            handle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                // If top handle, maybe allowing dragging existing edge? (Skip for now)
                if (position === 'top') return;
                startConnection(e, nodeId, position);
            });

            // Handle Drop (MouseUp) for connecting
            handle.addEventListener('mouseup', (e) => {
                e.stopPropagation();
                endConnection(e, nodeId, position);
            });

            parent.appendChild(handle);
        }

        // --- Helper: Math for Connections ---
        function getHandleCoords(node, pos) {
            const width = 260; // configured in CSS
            const height = 80; // approximate, better to read clientHeight
            // Since we re-render, we can't easily read DOM rects instantly within render loop
            // We'll estimate based on fixed css for this prototype
            let x = node.x;
            let y = node.y;

            if (pos === 'top') { x += width / 2; }
            if (pos === 'bottom') { x += width / 2; y += 85; } // approx height
            if (pos === 'bottom-left') { x += width * 0.25; y += 85; }
            if (pos === 'bottom-right') { x += width * 0.75; y += 85; }

            return { x, y };
        }

        function createPath(n1, n2, h1, h2) {
            const p1 = getHandleCoords(n1, h1);
            const p2 = getHandleCoords(n2, h2);

            // Bezier Control Points (vertical)
            const cy1 = p1.y + 50;
            const cy2 = p2.y - 50;

            return `M ${p1.x} ${p1.y} C ${p1.x} ${cy1}, ${p2.x} ${cy2}, ${p2.x} ${p2.y}`;
        }

        // --- 3. INTERACTIONS ---

        // Dragging Node
        function startNodeDrag(e, id) {
            // Only left mouse button
            if (e.button !== 0) return;
            state.draggedNodeId = id;
            state.selectedNodeId = id;
            const node = state.nodes.find(n => n.id === id);
            state.dragOffset = {
                x: e.clientX - node.x,
                y: e.clientY - node.y
            };
            render(); // update selection state immediately
        }

        window.addEventListener('mousemove', (e) => {
            // Node Dragging
            if (state.draggedNodeId) {
                const node = state.nodes.find(n => n.id === state.draggedNodeId);
                node.x = e.clientX - state.dragOffset.x;
                node.y = e.clientY - state.dragOffset.y;
                requestAnimationFrame(render);
            }

            // Connection Creating
            if (state.isConnecting) {
                const rect = canvas.getBoundingClientRect();
                state.tempConnectionPos = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top + canvas.scrollTop // basic scroll handling
                };
                requestAnimationFrame(render);
            }
        });

        window.addEventListener('mouseup', (e) => {
            if (state.draggedNodeId) {
                state.draggedNodeId = null;
            }
            // If we released mouse button anywhere while connecting, cancel it
            // (Unless it was handled by handle/node mouseup, which stopPropagation)
            if (state.isConnecting) {
                cancelConnection();
            }
        });

        // Connecting
        function startConnection(e, nodeId, handlePos) {
            if (handlePos === 'top') return; // Can't start from an input
            state.isConnecting = true;
            state.connectingSourceId = nodeId;
            state.connectingSourceHandle = handlePos;

            // Set initial position
            const rect = canvas.getBoundingClientRect();
            state.tempConnectionPos = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function endConnection(e, nodeId, handlePos) {
            if (!state.isConnecting) return;
            if (state.connectingSourceId === nodeId) return; // Self connection
            // We assume if dropping on node body (handlePos='top' from listener), it's a valid target

            // Add Edge
            state.edges.push({
                id: 'e' + Date.now(),
                source: state.connectingSourceId,
                target: nodeId,
                sourceHandle: state.connectingSourceHandle,
                targetHandle: handlePos
            });

            state.isConnecting = false;
            state.connectingSourceId = null;
            render();
        }

        function cancelConnection() {
            state.isConnecting = false;
            state.connectingSourceId = null;
            render();
        }

        // --- 4. DRAG FROM SIDEBAR ---
        function dragStart(event) {
            event.dataTransfer.setData("type", event.target.dataset.type);
            event.dataTransfer.setData("label", event.target.dataset.label);
            event.dataTransfer.setData("icon", event.target.dataset.icon);
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function drop(event) {
            event.preventDefault();
            const type = event.dataTransfer.getData("type");
            const label = event.dataTransfer.getData("label");
            const icon = event.dataTransfer.getData("icon");

            if (type) {
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                const newNode = {
                    id: 'n' + Date.now(),
                    type,
                    label,
                    icon,
                    x: x - 130, // center
                    y: y - 40,
                    data: { desc: "New Node" }
                };

                state.nodes.push(newNode);
                render();
            }
        }

        // --- 5. UTILS ---
        function deleteNode(id, e) {
            e.stopPropagation();
            if (confirm("Delete this node?")) {
                state.nodes = state.nodes.filter(n => n.id !== id);
                state.edges = state.edges.filter(e => e.source !== id && e.target !== id);
                render();
            }
        }

        function showJSON() {
            const output = document.getElementById('json-output');
            output.value = JSON.stringify(state, null, 2);
            document.getElementById('json-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('json-modal').style.display = 'none';
        }

        // Initial Render
        render();

    </script>

    
    <!-- Load Socket.IO client from CDN -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <!-- Load shared utilities -->
    <script src="/admin/js/auth.js"></script>
    <script src="/admin/js/api.js"></script>
    <script src="/admin/js/socket.js"></script>
    <script src="/admin/js/utils.js"></script>
    
    <!-- Auth protection -->
    <script>
        // Redirect to login if not authenticated
        if (!requireAuth()) {
            // requireAuth() handles redirect
        }
    </script>
    
</body>

</html>