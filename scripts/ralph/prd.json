{
  "feature": "ReplyHQ SDK",
  "description": "Kotlin Multiplatform SDK for in-app customer support chat with offline support, real-time messaging, and push notifications",
  "version": "1.0.0",
  "branchName": "ralph/replyhq-sdk",
  "stories": [
    {
      "id": "SDK-001",
      "title": "Project scaffolding & Gradle setup",
      "description": "Set up the KMP SDK module structure with Gradle configuration.\n\n**What to do:**\n- Create sdk module with commonMain, androidMain, iosMain source sets\n- Configure Gradle with KMP plugin, targets (Android SDK 28+, iOS 15+)\n- Add core dependencies: Kotlin Stdlib, Kotlinx Coroutines, Kotlinx Serialization, Ktor Client, SQLDelight, Kotlinx DateTime\n- Set up package structure: dev.replyhq.sdk with config/, ui/, data/, core/, platform/ directories\n\n**Acceptance criteria:**\n- ./gradlew :sdk:build compiles without errors\n- Source sets are properly configured for common, Android, and iOS",
      "passes": true,
      "dependsOn": []
    },
    {
      "id": "SDK-002",
      "title": "Platform expect/actual declarations",
      "description": "Create platform abstraction layer with expect/actual declarations.\n\n**What to do:**\n- Create platform/Platform.kt with expect val platformName: String\n- Create platform/Connectivity.kt with expect class for network monitoring\n- Create platform/PushNotifications.kt with expect class for FCM/APNs\n- Create platform/Preferences.kt with expect class for SharedPreferences/NSUserDefaults\n- Implement actual declarations for Android and iOS\n\n**Files:**\n- sdk/src/commonMain/kotlin/dev/replyhq/sdk/platform/\n- sdk/src/androidMain/kotlin/dev/replyhq/sdk/platform/\n- sdk/src/iosMain/kotlin/dev/replyhq/sdk/platform/\n\n**Acceptance criteria:**\n- ./gradlew :sdk:build passes\n- Platform.name returns 'android' or 'ios' correctly",
      "passes": true,
      "dependsOn": ["SDK-001"]
    },
    {
      "id": "SDK-003",
      "title": "Configuration data classes",
      "description": "Create all configuration container classes.\n\n**What to do:**\n- Create config/ChatConfig.kt - main config container\n- Create config/ChatUser.kt - user identification (id, name, email, attributes)\n- Create config/ChatTheme.kt - appearance (accentColor, bubblePosition, darkMode)\n- Create config/ChatBehavior.kt - runtime behavior (showBubble, enableOfflineQueue, maxOfflineMessages, attachmentsEnabled, typingIndicators)\n- Create config/NetworkConfig.kt - timeout, retryPolicy, maxRetries\n\n**Acceptance criteria:**\n- All data classes compile\n- Default values match PRD spec\n- ./gradlew :sdk:build passes",
      "passes": true,
      "dependsOn": ["SDK-001"]
    },
    {
      "id": "SDK-004",
      "title": "Data models - Conversation & Message",
      "description": "Create core data model entities.\n\n**What to do:**\n- Create data/models/Conversation.kt with id, visitorId, createdAt, updatedAt, metadata\n- Create data/models/Message.kt with id, localId, conversationId, content, senderType (USER/AGENT/SYSTEM), sentAt, status (QUEUED/SENDING/SENT/DELIVERED/READ/FAILED)\n- Create data/models/DeviceContext.kt with platform, osVersion, appVersion, deviceModel, locale, timezone\n\n**Acceptance criteria:**\n- Models use kotlinx.serialization annotations\n- ./gradlew :sdk:build passes",
      "passes": true,
      "dependsOn": ["SDK-001"]
    },
    {
      "id": "SDK-005",
      "title": "SQLDelight database schema",
      "description": "Set up local persistence with SQLDelight.\n\n**What to do:**\n- Create SQLDelight schema files for Conversation and Message tables\n- Add queries: insertMessage, getMessagesByConversation, getQueuedMessages, updateMessageStatus\n- Create data/local/ChatDatabase.kt wrapper\n- Create data/local/MessageQueue.kt for offline queue operations\n- Create data/local/Preferences.kt for SDK state storage\n\n**Acceptance criteria:**\n- SQLDelight generates type-safe code\n- ./gradlew :sdk:build passes\n- Can insert and query messages",
      "passes": true,
      "dependsOn": ["SDK-004"]
    },
    {
      "id": "SDK-006",
      "title": "Ktor HTTP client - ChatApi",
      "description": "Implement REST API client.\n\n**What to do:**\n- Create data/remote/ChatApi.kt with Ktor HttpClient\n- Implement endpoints:\n  - POST /conversations - get or create conversation\n  - POST /conversations/:id/messages - send message\n  - GET /conversations/:id/messages?after=<ts> - fetch messages\n  - POST /push-token - register push token\n- Add headers: X-App-Id, X-Device-Id, X-SDK-Version, Content-Type\n- Base URL: https://api.replyhq.dev/v1\n\n**Acceptance criteria:**\n- API client compiles\n- Request/response DTOs use kotlinx.serialization\n- ./gradlew :sdk:build passes",
      "passes": true,
      "dependsOn": ["SDK-003", "SDK-004"]
    },
    {
      "id": "SDK-007",
      "title": "WebSocket realtime client",
      "description": "Implement WebSocket handler for real-time messaging.\n\n**What to do:**\n- Create data/remote/RealtimeClient.kt with Ktor WebSocket\n- Connect to wss://api.replyhq.dev/v1/realtime?app_id=xxx&device_id=xxx\n- Handle server events: message.new, agent.typing\n- Send client events: user.typing, ping\n- Implement heartbeat ping every 30s\n\n**Acceptance criteria:**\n- WebSocket connects and receives messages\n- Exposes Flow<RealtimeEvent> for consumers\n- ./gradlew :sdk:build passes",
      "passes": true,
      "dependsOn": ["SDK-006"]
    },
    {
      "id": "SDK-008",
      "title": "ConnectionManager state machine",
      "description": "Implement connection lifecycle management.\n\n**What to do:**\n- Create core/ConnectionManager.kt with states: DISCONNECTED, CONNECTING, CONNECTED, RECONNECTING\n- Implement connect(), disconnect(), pause(), resume() methods\n- Add exponential backoff reconnection: 1s → 2s → 4s → 8s → max 30s\n- Listen to platform Connectivity for network changes\n\n**Acceptance criteria:**\n- State transitions are correct\n- Auto-reconnect on network restore\n- ./gradlew :sdk:build passes",
      "passes": true,
      "dependsOn": ["SDK-002", "SDK-007"]
    },
    {
      "id": "SDK-009",
      "title": "SyncManager offline sync",
      "description": "Implement offline message synchronization.\n\n**What to do:**\n- Create core/SyncManager.kt\n- On network restore: fetch queued messages, send oldest first\n- Update message state: QUEUED → SENDING → SENT or FAILED\n- Max 3 retries per message before FAILED\n- On reconnect: fetch missed messages from server\n\n**Acceptance criteria:**\n- Messages sent offline sync when online\n- No duplicates (server dedupes by local_id)\n- ./gradlew :sdk:build passes",
      "passes": true,
      "dependsOn": ["SDK-005", "SDK-008"]
    },
    {
      "id": "SDK-010",
      "title": "SessionManager lifecycle",
      "description": "Implement session and user management.\n\n**What to do:**\n- Create core/SessionManager.kt\n- Generate and persist device_id (UUID v4) on first launch\n- Handle setUser() - starts/continues conversation\n- Handle clearUser() - ends session\n- Auto-detect app foreground/background\n\n**Acceptance criteria:**\n- Device ID persists across launches\n- User changes trigger new conversation\n- ./gradlew :sdk:build passes",
      "passes": true,
      "dependsOn": ["SDK-005", "SDK-008"]
    },
    {
      "id": "SDK-011",
      "title": "DeviceContextCollector",
      "description": "Implement device metadata collection.\n\n**What to do:**\n- Create core/DeviceContextCollector.kt\n- Collect: platform, osVersion, appVersion, deviceModel, locale, timezone\n- Use expect/actual for platform-specific collection\n\n**Acceptance criteria:**\n- Returns valid DeviceContext on both platforms\n- ./gradlew :sdk:build passes",
      "passes": true,
      "dependsOn": ["SDK-002", "SDK-004"]
    },
    {
      "id": "SDK-012",
      "title": "ChatSDK main entry point",
      "description": "Create the main SDK singleton with public API.\n\n**What to do:**\n- Create ChatSDK.kt as object singleton\n- Implement init(context, appId) minimal version\n- Implement init(context, config) full version\n- Implement setUser(), clearUser()\n- Implement open(), close()\n- Expose unreadCount: StateFlow<Int>\n- Implement onAppForegrounded(), onAppBackgrounded()\n- Implement reset() for debug\n\n**Acceptance criteria:**\n- Public API matches PRD spec\n- Fail fast on missing appId\n- ./gradlew :sdk:build passes",
      "passes": true,
      "dependsOn": ["SDK-009", "SDK-010", "SDK-011"]
    },
    {
      "id": "SDK-013",
      "title": "Chat theme system",
      "description": "Implement theming for chat UI.\n\n**What to do:**\n- Create ui/theme/ChatTheme.kt with Compose theming\n- Support accentColor, darkMode (LIGHT/DARK/SYSTEM)\n- Create color scheme for message bubbles, backgrounds, text\n\n**Acceptance criteria:**\n- Theme applies to all UI components\n- Dark mode works correctly\n- ./gradlew :sdk:build passes",
      "passes": true,
      "dependsOn": ["SDK-003"]
    },
    {
      "id": "SDK-014",
      "title": "MessageBubble component",
      "description": "Create individual message rendering component.\n\n**What to do:**\n- Create ui/components/MessageBubble.kt\n- Different styles for USER vs AGENT messages\n- Show timestamp, delivery status indicators\n- Handle long text wrapping\n- Show 'sending' indicator for QUEUED/SENDING\n- Show 'tap to retry' for FAILED\n\n**Acceptance criteria:**\n- Messages display correctly\n- Status indicators visible\n- ./gradlew :sdk:build passes",
      "passes": false,
      "dependsOn": ["SDK-013"]
    },
    {
      "id": "SDK-015",
      "title": "MessageList component",
      "description": "Create scrollable message list.\n\n**What to do:**\n- Create ui/components/MessageList.kt\n- LazyColumn with MessageBubble items\n- Auto-scroll to bottom on new message\n- Support pull-to-refresh for older messages\n\n**Acceptance criteria:**\n- Scrolls smoothly\n- New messages appear at bottom\n- ./gradlew :sdk:build passes",
      "passes": false,
      "dependsOn": ["SDK-014"]
    },
    {
      "id": "SDK-016",
      "title": "InputBar component",
      "description": "Create text input with send button.\n\n**What to do:**\n- Create ui/components/InputBar.kt\n- Text field with send button\n- Disable send for empty text\n- Client-side validation: 5000 char limit\n- Rate limit: 5 msgs/second\n\n**Acceptance criteria:**\n- Can type and send messages\n- Validation prevents invalid sends\n- ./gradlew :sdk:build passes",
      "passes": false,
      "dependsOn": ["SDK-013"]
    },
    {
      "id": "SDK-017",
      "title": "TypingIndicator component",
      "description": "Create agent typing animation.\n\n**What to do:**\n- Create ui/components/TypingIndicator.kt\n- Animated dots when agent is typing\n- Show/hide based on realtime events\n\n**Acceptance criteria:**\n- Animation plays smoothly\n- Appears when agent.typing event received\n- ./gradlew :sdk:build passes",
      "passes": false,
      "dependsOn": ["SDK-013"]
    },
    {
      "id": "SDK-018",
      "title": "ConnectionStatus component",
      "description": "Create online/offline indicator.\n\n**What to do:**\n- Create ui/components/ConnectionStatus.kt\n- Show banner when offline\n- Show reconnecting state\n- Hide when connected\n\n**Acceptance criteria:**\n- Correctly reflects ConnectionManager state\n- ./gradlew :sdk:build passes",
      "passes": false,
      "dependsOn": ["SDK-013"]
    },
    {
      "id": "SDK-019",
      "title": "ChatScreen full interface",
      "description": "Assemble full chat screen from components.\n\n**What to do:**\n- Create ui/ChatScreen.kt composable\n- Combine: ConnectionStatus, MessageList, TypingIndicator, InputBar\n- Wire to ChatSDK for data and actions\n- Handle keyboard properly (doesn't cover input)\n- Support onDismiss callback\n\n**Acceptance criteria:**\n- Full chat experience works\n- Keyboard behavior correct\n- ./gradlew :sdk:build passes",
      "passes": false,
      "dependsOn": ["SDK-012", "SDK-015", "SDK-016", "SDK-017", "SDK-018"]
    },
    {
      "id": "SDK-020",
      "title": "ChatBubble FAB component",
      "description": "Create floating action button.\n\n**What to do:**\n- Create ui/ChatBubble.kt composable\n- Show unread badge from ChatSDK.unreadCount\n- Support bubblePosition (BOTTOM_LEFT, BOTTOM_RIGHT)\n- Tap opens ChatScreen\n\n**Acceptance criteria:**\n- FAB displays correctly\n- Unread count shows\n- Opens chat on tap\n- ./gradlew :sdk:build passes",
      "passes": false,
      "dependsOn": ["SDK-012", "SDK-013"]
    },
    {
      "id": "SDK-021",
      "title": "Push notification token registration",
      "description": "Implement push token management.\n\n**What to do:**\n- Create data/remote/PushTokenManager.kt\n- On token refresh: POST to /push-token\n- Android: integrate with Firebase Messaging\n- iOS: integrate with APNs\n\n**Acceptance criteria:**\n- Token registered with server\n- Works on both platforms\n- ./gradlew :sdk:build passes",
      "passes": false,
      "dependsOn": ["SDK-002", "SDK-006"]
    },
    {
      "id": "SDK-022",
      "title": "Push notification handling",
      "description": "Handle incoming push notifications.\n\n**What to do:**\n- Parse push payload for new messages\n- Android: show notification, tap opens chat\n- iOS: show notification, tap opens chat\n- Update unread count\n\n**Acceptance criteria:**\n- Notifications display when app backgrounded\n- Tap opens chat screen\n- ./gradlew :sdk:build passes",
      "passes": false,
      "dependsOn": ["SDK-021", "SDK-012"]
    },
    {
      "id": "SDK-023",
      "title": "iOS SwiftUI wrapper",
      "description": "Create SwiftUI wrapper for iOS.\n\n**What to do:**\n- Create Swift wrapper ReplyHQChatView\n- Wrap Compose Multiplatform ChatScreen\n- Expose ChatSDK methods to Swift\n\n**Files:**\n- iosApp/iosApp/ReplyHQChatView.swift\n\n**Acceptance criteria:**\n- SwiftUI app can import and use ReplyHQChatView\n- All SDK methods accessible from Swift\n- ./gradlew :sdk:build passes",
      "passes": false,
      "dependsOn": ["SDK-019"]
    },
    {
      "id": "SDK-024",
      "title": "Error handling & edge cases",
      "description": "Implement comprehensive error handling.\n\n**What to do:**\n- Handle: app killed mid-send, duplicate sends, token expired (401)\n- Handle: server down, WebSocket dies, user reinstalls\n- Handle: user switches account, message too long, rapid messages\n- Handle: no app_id (throw on init), invalid app_id (403)\n- All errors gracefully logged, no crashes\n\n**Acceptance criteria:**\n- All error scenarios handled per PRD table\n- Crash-free rate target: >99.9%\n- ./gradlew :sdk:build passes",
      "passes": false,
      "dependsOn": ["SDK-009", "SDK-012"]
    },
    {
      "id": "SDK-025",
      "title": "Unit tests - core logic",
      "description": "Write unit tests for core components.\n\n**What to do:**\n- Test ConnectionManager state transitions\n- Test SyncManager queue logic\n- Test SessionManager user management\n- Test message serialization/deserialization\n\n**Acceptance criteria:**\n- All core logic covered\n- ./gradlew :sdk:test passes",
      "passes": false,
      "dependsOn": ["SDK-012"]
    },
    {
      "id": "SDK-026",
      "title": "Integration tests - offline sync",
      "description": "Write integration tests for offline scenarios.\n\n**What to do:**\n- Test: send message online → appears\n- Test: send offline → queued → syncs when online\n- Test: kill app offline, reopen online → syncs\n- Test: airplane mode toggle spam → no duplicates\n\n**Acceptance criteria:**\n- All offline scenarios pass\n- ./gradlew :sdk:test passes",
      "passes": false,
      "dependsOn": ["SDK-025"]
    },
    {
      "id": "SDK-027",
      "title": "UI tests",
      "description": "Write UI tests for chat components.\n\n**What to do:**\n- Test: typing indicator shows\n- Test: long messages wrap correctly\n- Test: keyboard doesn't cover input\n- Test: dark mode looks correct\n- Test: chat scrolls to bottom on new message\n\n**Acceptance criteria:**\n- UI tests pass on Android and iOS\n- ./gradlew :sdk:test passes",
      "passes": false,
      "dependsOn": ["SDK-019", "SDK-025"]
    },
    {
      "id": "SDK-028",
      "title": "Sample app - Android",
      "description": "Create Android sample application.\n\n**What to do:**\n- Update composeApp to demonstrate SDK\n- Demonstrate minimal init and full config init\n- Show ChatBubble and ChatScreen usage\n- Include user login/logout flow\n\n**Acceptance criteria:**\n- Sample app builds and runs\n- Demonstrates all SDK features\n- ./gradlew :composeApp:assembleDebug passes",
      "passes": false,
      "dependsOn": ["SDK-019", "SDK-020", "SDK-022"]
    },
    {
      "id": "SDK-029",
      "title": "Sample app - iOS",
      "description": "Create iOS sample application.\n\n**What to do:**\n- Update iosApp to demonstrate SDK\n- Use SwiftUI wrapper ReplyHQChatView\n- Demonstrate SDK initialization and usage\n\n**Acceptance criteria:**\n- Sample app builds and runs on iOS\n- Demonstrates all SDK features",
      "passes": false,
      "dependsOn": ["SDK-023", "SDK-028"]
    },
    {
      "id": "SDK-030",
      "title": "Performance optimization",
      "description": "Optimize SDK performance to meet targets.\n\n**What to do:**\n- Measure and optimize cold start overhead (target: <50ms)\n- Optimize memory footprint (target: <10MB idle)\n- Minimize SDK size (Android: <2MB, iOS: <3MB)\n- Profile and fix any bottlenecks\n\n**Acceptance criteria:**\n- All performance metrics met per PRD\n- ./gradlew :sdk:build passes",
      "passes": false,
      "dependsOn": ["SDK-026", "SDK-027"]
    },
    {
      "id": "SDK-031",
      "title": "API documentation",
      "description": "Generate API documentation.\n\n**What to do:**\n- Add KDoc comments to all public APIs\n- Generate Dokka documentation\n- Create integration guide with code examples\n\n**Acceptance criteria:**\n- Documentation generated\n- All public APIs documented",
      "passes": false,
      "dependsOn": ["SDK-012"]
    },
    {
      "id": "SDK-032",
      "title": "Android Maven Central publishing",
      "description": "Set up Android artifact publishing.\n\n**What to do:**\n- Configure Gradle for Maven Central publishing\n- Set up signing keys\n- Create release workflow\n\n**Acceptance criteria:**\n- Can publish AAR to Maven Central\n- SDK size <2MB",
      "passes": false,
      "dependsOn": ["SDK-030", "SDK-031"]
    },
    {
      "id": "SDK-033",
      "title": "iOS XCFramework publishing",
      "description": "Set up iOS artifact publishing.\n\n**What to do:**\n- Configure XCFramework generation\n- Set up Swift Package Manager manifest\n- Create release workflow\n\n**Acceptance criteria:**\n- Can publish XCFramework via SPM\n- SDK size <3MB",
      "passes": false,
      "dependsOn": ["SDK-030", "SDK-031"]
    }
  ]
}
